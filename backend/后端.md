# 后端设计文档

## 技术栈

- **框架**: Node.js + Express
- **数据库**: MySQL + Prisma ORM
- **认证**: JWT Token
- **图片处理**: Sharp (缩略图生成)
- **EXIF 解析**: ExifReader
- **AI 功能**: Qwen/Gemini API

## 数据库表结构

### 用户表 (t_user)
- `id`: 用户唯一标识
- `username`: 用户名（唯一）
- `password`: 加密后的密码
- `email`: 邮箱（唯一）
- `created_at`: 注册时间
- `updated_at`: 更新时间

### 图片表 (t_image)
- `id`: 图片唯一标识
- `user_id`: 所属用户ID
- `original_filename`: 原始文件名
- `stored_path`: 服务器存储路径
- `thumbnail_path`: 缩略图路径
- `file_size`: 文件大小
- `resolution`: 分辨率
- `shooting_time`: 拍摄时间（EXIF）
- `location`: 拍摄地点（EXIF）
- `device_info`: 设备信息（EXIF）
- `created_at`: 上传时间

### 标签表 (t_tag)
- `id`: 标签唯一标识
- `name`: 标签名称（唯一）
- `type`: 标签类型（1:用户自定义, 2:EXIF, 3:AI）
- `created_at`: 创建时间

### 图片-标签关联表 (t_image_tag_relation)
- `id`: 关联记录ID
- `image_id`: 图片ID
- `tag_id`: 标签ID

## 核心功能模块

### 1. 用户认证模块 (`/api/auth`)

**用户注册** `POST /register`
- 校验用户名（≥6字节）、密码（≥6字节）、邮箱格式
- 检查用户名和邮箱唯一性
- 密码加密后存储

**用户登录** `POST /login`
- 验证用户名/邮箱和密码
- 生成 JWT Token 返回

**获取当前用户** `GET /me`
- 验证 Token，返回当前用户信息

### 2. 图片管理模块 (`/api/images`)

**图片上传** `POST /upload`
- 接收图片文件，保存到服务器
- 使用 Sharp 生成缩略图
- 使用 ExifReader 提取 EXIF 信息（拍摄时间、地点、设备等）
- 将图片信息和 EXIF 数据存入数据库
- 自动创建 EXIF 标签并关联

**图片列表** `GET /`
- 支持多条件查询：文件名、时间范围、标签、EXIF 信息
- 支持分页
- 返回图片列表和缩略图路径

**图片详情** `GET /:id`
- 返回单张图片的完整信息
- 包含关联的所有标签

**更新图片信息** `PUT /:id`
- 更新图片的基本信息（文件名等）

**删除图片** `DELETE /:id`
- 删除数据库记录
- 删除原始文件和缩略图
- 删除标签关联

**图片编辑** `POST /:id/edit`
- 接收编辑后的图片数据
- 覆盖原始文件
- 重新生成缩略图

**AI 标签生成** `POST /:id/ai-tags`
- 读取图片文件
- 调用 AI 模型（Qwen/Gemini）分析图片内容
- 自动生成标签（如"风景"、"人物"、"动物"等）
- 保存 AI 标签并关联到图片

### 3. 标签管理模块 (`/api/images/:id/tags`)

**添加标签** `POST /`
- 为图片添加自定义标签
- 如果标签不存在则自动创建
- 建立图片与标签的关联

**删除标签** `DELETE /:tagId`
- 移除图片与指定标签的关联

### 4. 标签查询模块 (`/api/tags`)

**获取所有标签** `GET /`
- 返回系统中所有标签列表
- 可按类型筛选（用户自定义/EXIF/AI）

### 5. AI 智能检索模块 (`/api/ai`)

**自然语言检索** `POST /search-by-dialog`
- 接收用户的自然语言查询（如"找找我在海边拍的照片"）
- 调用大语言模型（Qwen/Gemini）解析查询意图
- 将自然语言转换为结构化查询条件（标签、时间范围等）
- 调用图片检索接口返回结果

## 中间件

### JWT 认证中间件
- 拦截需要认证的请求
- 验证 Token 有效性
- 解析用户信息并注入到 request 对象

### 错误处理中间件
- 统一处理各类错误
- 返回标准的错误响应格式

### 文件上传中间件
- 使用 multer 处理文件上传
- 限制文件大小和类型

## 目录结构

```
backend/
├── src/
│   ├── routes/          # 路由定义
│   ├── controllers/     # 业务逻辑
│   ├── middlewares/     # 中间件
│   ├── services/        # 服务层（AI、图片处理）
│   ├── utils/           # 工具函数
│   └── index.js         # 入口文件
├── uploads/             # 图片存储目录
│   ├── originals/       # 原图
│   └── thumbnails/      # 缩略图
├── prisma/
│   └── schema.prisma    # 数据库模型定义
├── package.json
└── Dockerfile
```

## 部署

使用 Docker Compose 进行容器化部署：
- 后端服务容器（backend-service）
- MySQL 数据库容器（mysql-service）
- Nginx 反向代理容器（nginx-service）

环境变量配置：
- `DATABASE_URL`: MySQL 连接字符串
- `JWT_SECRET`: JWT 密钥
- `AI_API_KEY`: AI 服务 API 密钥
- `PORT`: 服务端口（默认 3000）

