// 文档基础设置
#set document(
  title: "图片管理网站 - 项目设计文档",
  author: "潘伦可",
)
#set heading(numbering: "1.1")

// 封面页
#align(center)[
  #text(size: 20pt, weight: "bold")[《BS 体系软件设计》大作业]

  #v(2em)

  #text(size: 26pt, weight: "bold")[图片管理网站]
  #text(size: 20pt, weight: "bold")[项目设计文档]

  #v(10em)

  #table(
    columns: (2fr, 5fr),
    align: (left, left),
    stroke: none,
    [*项目名称*], [图片管理网站],
    [*课程名称*], [BS 体系软件设计],
    [*学生姓名*], [潘伦可],
    [*学生学号*], [3230102935],
    [*指导教师*], [胡晓君],
    [*文档版本*], [V1.0],
    [*完成日期*], [2025年11月17日],
  )
]

#pagebreak()

// 目录
#outline(
  title: [目录],
  depth: 3,
  indent: 1.5em,
)

#pagebreak()

= 引言 <intro>

== 设计目标 <goals>
本项目旨在设计并实现一个现代、易用、高效的个人图片管理网站。系统将支持用户通过多种设备上传、管理、检索和分享自己的图片资源。同时，系统将利用自动化技术（如 EXIF 信息提取）和人工智能技术（图片内容分析）来提升用户体验，实现图片的智能分类和检索。

== 文档目的 <purpose>
本设计文档作为项目开发阶段的指导性文件，其主要目的包括：
- 明确项目的功能与非功能性需求。
- 确定系统的技术架构、技术选型和部署方案。
- 完成数据库和核心模块的详细设计。
- 定义前后端交互的 API 接口规范。
- 为后续的编码、测试和部署工作提供清晰的蓝图和依据。

= 需求分析 <requirements>

== 功能性需求 <func-req>
#table(
  columns: (18%, 22%, 60%),
  inset: 8pt,
  align: (left, left, left),
  table.header(
    [*模块*], [*功能点*], [*详细描述*],
  ),
  [用户管理], [用户注册], [用户名（6字节以上）、密码（6字节以上）、Email（格式验证）。用户名和 Email 系统唯一。],
  [], [用户登录], [提供登录接口，登录成功后维持会话状态（如使用 Token）。],
  [图片管理], [图片上传], [支持 PC 和手机浏览器上传单张或多张图片。],
  [], [缩略图生成], [图片上传成功后，后台自动生成固定尺寸的缩略图，用于列表页展示。],
  [], [EXIF 信息提取], [自动读取图片的 EXIF 信息，提取拍摄时间、地点、设备、分辨率等存入数据库。],
  [], [自定义标签], [用户可以为单张或多张图片添加自定义分类标签。],
  [], [图片编辑], [提供基础编辑功能，如对图片进行裁剪、调整色调（亮度、对比度、饱和度等）。],
  [], [图片删除], [用户可以删除自己上传的图片，同时删除数据库记录、原始文件和缩略图。],
  [图片检索], [条件查询], [提供查询界面，支持根据文件名、上传时间范围、自定义标签、EXIF 信息（如拍摄地点）进行组合查询。],
  [图片展示], [瀑布流/网格展示], [在主界面以瀑布流或网格形式展示图片缩略图。],
  [], [轮播展示], [用户可以选择多张图片，进行全屏轮播（Carousel）展示。],
  [], [响应式布局], [网站样式能自动适配 PC、平板和手机屏幕，在移动端浏览器或微信内置浏览器中友好显示。],
  [增强功能], [AI 智能标签], [调用 AI 模型分析图片内容，自动生成如“风景”、“人物”、“动物”、“建筑”等多类型标签。],
  [], [大模型对话检索], [提供一个对话接口，能够接收自然语言查询（如“找找我在海边拍的照片”），通过大语言模型理解意图后，转换为结构化查询条件来检索图片。],
)

== 非功能性需求 <non-func-req>
- *易用性*: 界面简洁直观，操作流程符合用户习惯，移动端体验良好。
- *性能*: 图片列表加载速度快，图片上传和处理响应迅速。
- *安全性*: 用户密码需加密存储。防止 SQL 注入等常见 Web 攻击。
- *可维护性*: 代码结构清晰，注释充分，遵循统一的编码规范。使用 Git 进行版本管理。

= 系统总体设计 <arch>

== 技术选型 <tech-stack>
为了实现前后端分离，提高开发效率和系统可维护性，拟采用以下技术栈：

- *前端*:
	+ *框架*: React 18
	+ *UI 库*: Ant Design
	+ *构建工具*: Create React App (CRA)
	+ *路由*: React Router
	+ *状态管理*: MobX
	+ *HTTP 请求*: Axios
	+ *图片编辑库*: Cropper.js
- *后端*:
	+ *框架*: Node.js + Express 
	+ *数据库 ORM*: Prisma
	+ *认证授权*: JWT Token
	+ *EXIF 解析库*: ExifReader
	+ *图片处理库*: Sharp
- *数据库*:
	+ *关系型数据库*: MySQL
- *AI 功能*:
	+ *图片内容分析*: 调用 Qwen、Gemini 等大模型的 API。
	+ *大模型对话*: 调用 Qwen、Gemini 等大模型的 API。
- *开发与部署*:
	+ *版本控制*: Git
	+ *容器化*: Docker, Docker Compose

== 系统架构 <sys-arch>
本系统采用经典的前后端分离 B/S 架构。

== 部署架构 <deploy-arch>
使用 Docker Compose 对整个应用进行容器化部署，统一管理各个服务。

- *`docker-compose.yml` 文件将定义以下服务:*
  + *`nginx-service`*: 部署前端静态文件，并作为反向代理，将 `/api` 请求转发至后端服务。
  + *`backend-service`*: 运行后端应用程序的 Docker 容器。
  + *`mysql-service`*: 运行 MySQL 数据库服务的容器。

= 数据库设计 <database>

== 数据表结构 <table-schema>

=== 用户表 (`t_user`)
#table(
  columns: (auto, auto, auto, 1fr),
  table.header(
    [*字段名*], [*类型*], [*约束*], [*描述*],
  ),
  [`id`], [`BIGINT`], [主键, 自增], [用户唯一标识],
  [`username`], [`VARCHAR(50)`], [非空, 唯一], [用户名],
  [`password`], [`VARCHAR(255)`], [非空], [加密后的密码],
  [`email`], [`VARCHAR(100)`], [非空, 唯一], [电子邮箱],
  [`created_at`], [`DATETIME`], [非空, 默认当前时间], [注册时间],
  [`updated_at`], [`DATETIME`], [非空, 默认当前时间], [更新时间],
)

=== 图片表 (`t_image`)
#table(
  columns: (auto, auto, auto, 1fr),
  table.header(
    [*字段名*], [*类型*], [*约束*], [*描述*],
  ),
  [`id`], [`BIGINT`], [主键, 自增], [图片唯一标识],
  [`user_id`], [`BIGINT`], [非空, 外键(`t_user.id`)], [所属用户ID],
  [`original_filename`], [`VARCHAR(255)`], [非空], [上传时的原始文件名],
  [`stored_path`], [`VARCHAR(500)`], [非空], [文件在服务器上的存储路径],
  [`thumbnail_path`], [`VARCHAR(500)`], [非空], [缩略图存储路径],
  [`file_size`], [`BIGINT`], [], [文件大小 (字节)],
  [`resolution`], [`VARCHAR(50)`], [], [图片分辨率 (如 `1920x1080`)],
  [`shooting_time`], [`DATETIME`], [], [(EXIF) 拍摄时间],
  [`location`], [`VARCHAR(255)`], [], [(EXIF) 拍摄地点],
  [`device_info`], [`VARCHAR(255)`], [], [(EXIF) 设备信息],
  [`created_at`], [`DATETIME`], [非空, 默认当前时间], [上传时间],
)

=== 标签表 (`t_tag`)
#table(
  columns: (auto, auto, auto, 1fr),
  table.header(
    [*字段名*], [*类型*], [*约束*], [*描述*],
  ),
  [`id`], [`BIGINT`], [主键, 自增], [标签唯一标识],
  [`name`], [`VARCHAR(50)`], [非空, 唯一], [标签名称],
  [`type`], [`TINYINT`], [非空, 默认1], [标签类型 (1:用户自定义, 2:EXIF, 3:AI)],
  [`created_at`], [`DATETIME`], [非空, 默认当前时间], [创建时间],
)

=== 图片-标签关联表 (`t_image_tag_relation`)
#table(
  columns: (auto, auto, auto, 1fr),
  table.header(
    [*字段名*], [*类型*], [*约束*], [*描述*],
  ),
  [`id`], [`BIGINT`], [主键, 自增], [关联记录ID],
  [`image_id`], [`BIGINT`], [非空, 外键(`t_image.id`)], [图片ID],
  [`tag_id`], [`BIGINT`], [非空, 外键(`t_tag.id`)], [标签ID],
)


= 模块详细设计 <module-design>

== 用户管理模块 <user-module>
- *注册流程*: 前端校验输入后，调用注册接口。后端再次校验数据唯一性，对密码进行加密处理后，存入数据库。
- *登录流程*: 用户提交凭证，后端验证凭证的正确性。验证成功后，生成有时效性的用户令牌（Token）并返回给前端。
- *认证拦截*: 前端在请求需要登录的接口时，自动携带令牌。后端通过统一的拦截器验证令牌的有效性，通过后才执行后续业务逻辑。

== 图片上传与处理模块 <upload-module>
- *上传流程*: 前端将图片文件上传至服务器。后端接收文件，以唯一ID重命名后保存，并立即启动一个异步的后台处理任务。
- *异步处理*:
  + 从图片文件中提取 EXIF 元数据（如拍摄时间、地点等）。
  + 根据原图生成一张或多张不同尺寸的缩略图。
  + 将图片的所有信息（包括文件路径、EXIF 数据等）存入数据库。

== 图片信息与标签管理模块 <tag-module>
- *EXIF 标签创建*: 在图片异步处理过程中，将提取到的 EXIF 信息作为标签。系统会自动创建尚不存在的标签，并建立图片与这些标签的关联。
- *自定义标签*: 用户为图片添加标签。后端会查询或创建该标签，并建立图片与该标签的关联。
- *标签删除*: 用户移除图片上的某个标签时，后端仅删除图片与该标签的关联记录。

== 图片检索与展示模块 <search-module>
- *检索接口*: 后端提供一个支持多种参数（如标签、时间、关键词）组合查询的接口。接口会根据参数查询数据库，并以分页的形式返回结果。
- *分页与懒加载*: 前端通过滚动加载或点击页码的方式，分批次请求图片数据，避免一次性加载大量内容。

== 图片编辑模块 <edit-module>
- *前端实现*: 用户在前端编辑器中对图片进行裁剪、旋转等可视化操作。
- *保存流程*: 用户确认编辑后，前端将修改后的图片数据上传。后端接收到数据后，用新图片覆盖旧的原始文件，并同步更新所有缩略图。

== AI 分析与检索模块 <ai-module>
- *AI 标签生成*: 用户在界面上手动触发对某张图片的 AI 分析。后端会调用第三方 AI 服务进行图片内容识别，并将返回的标签结果保存到数据库，与该图片关联。
- *大模型对话检索*:
  + 用户输入一段自然语言描述（如“找找我在海边的照片”）。
  + 后端将这段话发送给大语言模型，让其解析出结构化的查询条件（如标签、时间范围）。
  + 后端使用解析出的条件，调用常规的图片检索接口，将最终结果返回给用户。

= 接口（API）设计 <api-design>
本系统 API 基于 RESTful 风格设计，使用 JSON 格式进行数据交换，并通过 JWT 进行无状态认证。

- *用户认证 (`/api/auth`)*
  - `POST /register`: 用户注册
  - `POST /login`: 用户登录
  - `GET /me`: 获取当前登录用户信息

- *图片资源 (`/api/images`)*
  - `POST /upload`: 上传图片
  - `GET /`: 按条件检索图片列表
  - `GET /{id}`: 获取单张图片详情
  - `PUT /{id}`: 更新图片基本信息
  - `DELETE /{id}`: 删除图片
  - `POST /{id}/edit`: 提交编辑后的图片
  - `POST /{id}/ai-tags`: 触发对图片的 AI 分析

- *标签管理 (`/api/images/{id}/tags`)*
  - `POST /`: 为图片批量添加标签
  - `DELETE /{tagId}`: 移除图片的指定标签

- *通用标签接口 (`/api/tags`)*
  - `GET /`: 获取系统所有标签列表

- *AI 智能检索 (`/api/ai`)*
  - `POST /search-by-dialog`: 通过自然语言检索图片

= 界面（UI）设计 <ui-design>

== 主要页面设计 <ui-pages>
- *登录/注册页*: 居中布局，包含 Logo、输入表单和功能切换链接。
- *主页 (图片墙)*:
  + *顶部*: 导航栏，包含 Logo、搜索框、上传按钮和用户信息菜单。
  + *主内容区*: 采用响应式网格布局或瀑布流展示图片缩略图。支持进入“选择模式”，允许用户勾选多张图片进行批量操作（如批量添加标签、删除等）。
  + *侧边栏*: 显示标签云、时间线等快速过滤工具，在窄屏设备上可收起。
- *图片详情页*:
  + *左侧*: 显示高清大图，并提供“上一张”/“下一张”导航按钮，方便用户在当前列表（如相册或搜索结果）中快速切换。
  + *右侧*: 显示图片元数据（分辨率、时间、地点）、标签列表（可增删）、以及编辑/删除/下载等操作按钮。
- *上传页*: 提供一个直观的拖拽上传区域和传统的文件选择按钮，并清晰地显示每张图片的上传进度。

== 响应式设计策略 <responsive-design>
- *流式布局*: 优先使用 CSS Flexbox 和 Grid 进行页面整体布局，确保内容在不同尺寸的容器内能自然伸缩。
- *媒体查询*: 使用媒体查询 (`@media`) 设置关键断点（如手机、平板、桌面），针对不同屏幕宽度调整布局，例如：
  + 在手机端（`<768px`），将侧边栏收起到汉堡菜单中。
  + 根据屏幕宽度，动态调整图片墙的网格列数（如手机 2 列，平板 4 列，PC 6 列）。
- *组件库支持*: UI 库 (*Ant Design*) 本身提供了完善的响应式网格系统和组件，应充分利用以保证开发效率和体验一致性。


= 开发与部署计划 <plan>

== 开发计划与里程碑 <milestones>
- *第一阶段：基础架构与核心功能 (即日起 - 11月5日)*
  + 搭建前后端项目骨架，完成开发环境与 Docker 配置。
  + 完成数据库表结构设计与实现。
  + 实现用户模块，包括注册、登录及认证功能。
  + 实现图片上传、存储及缩略图生成的核心流程。

- *第二阶段：主要功能开发与联调 (11月6日 - 11月26日)*
  + 后端实现 EXIF 信息提取、自定义标签管理功能。
  + 实现强大的条件检索接口，支持多维度查询。
  + 前端完成主页图片墙、详情页等核心页面开发。
  + 完成前后端主要功能的接口联调与测试。

- *第三阶段：增强功能与体验完善 (11月27日 - 12月5日)*
  + 实现图片在线编辑功能。
  + 集成 AI 服务，实现智能标签生成与自然语言检索。
  + 全面优化 UI 界面，完善响应式布局，确保多端体验一致。

- *第四阶段：优化、测试与文档整理 (12月6日 - 1月5日)*
  + 进行全面的功能测试与性能测试，集中修复 Bug。
  + 对代码进行重构，优化数据库查询和前后端性能。
  + 撰写项目报告、使用手册，并录制功能演示视频。

- *最终提交 (1月5日前)*: 整理并提交所有项目材料。

== 版本控制策略 <git-strategy>
- *代码管理*: 使用 Git 进行代码管理，推荐使用 Gitee 或 GitHub 创建私有仓库，统一存放前后端所有代码。
- *提交规范*: 遵循“语义化提交”规范，例如 `feat: complete user login api`，使提交历史清晰可读。

== 容器化部署方案 <docker-plan>
项目整体使用 Docker Compose (`docker-compose.yml`) 进行容器化编排，实现一键启动。

- *后端服务 (`backend-service`)*:通过 `Dockerfile` 将 Node.js Express 应用打包成一个独立的服务镜像。

- *前端服务 (`nginx-service`)*:采用多阶段构建的 `Dockerfile`：先用 Node.js 环境将 React 项目编译成静态文件，再将产物交给 Nginx 镜像进行托管和代理。

- *数据库服务 (`mysql-service`)*:直接使用官方的 `mysql:8.0` 镜像。